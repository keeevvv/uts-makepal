name: CI/CD - Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  version-check-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Menggunakan versi terbaru
        with:
          fetch-depth: 0 # Diperlukan untuk mengakses riwayat git

      - name: Get current version
        id: current_version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: Get previous version from main
        id: previous_version
        run: echo "version=$(git show origin/main:package.json | jq -r .version)" >> $GITHUB_OUTPUT

      - name: Compare versions
        run: |
          current_v="${{ steps.current_version.outputs.version }}"
          previous_v="${{ steps.previous_version.outputs.version }}"

          echo "Current version: $current_v"
          echo "Previous version: $previous_v"

          # Jika versi saat ini sama dengan versi sebelumnya (misalnya pada PR yang belum update versi), lewati error
          if [ "$current_v" = "$previous_v" ]; then
            echo "🟡 Versions are the same. No new version detected."
            exit 0
          fi

          # Cek jika versi baru lebih tinggi dari versi lama
          highest_version=$(printf '%s\n' "$previous_v" "$current_v" | sort -V | tail -n1)

          if [ "$highest_version" = "$current_v" ]; then
            echo "✅ Version check passed. New version is higher."
          else
            echo "❌ Version must be higher than previous ($previous_v). Current is $current_v."
            exit 1
          fi
